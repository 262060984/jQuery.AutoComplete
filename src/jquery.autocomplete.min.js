/*
* jQuery.autocomplete.js (v1.0.0)
* authored by nswish (nswish@gmail.com)
* jQuery 1.7.1+ support
* compatible: ie/chrome/firefox/opera/safari
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
(function(f){f.fn.extend({"AutoComplete":function(p){return this.each(function(){if(!(this&&this.tagName==="INPUT"&&this.type==="text")){return}if(this.controller){this.controller.setOption(p)}else{if(f.isPlainObject(p)){this.controller=new d(this,p)}}})}});var d=function(p,q){this.option=f.extend(false,{"width":320,"maxHeight":null,"itemHeight":null,"listStyle":"normal","listDirection":"down","data":[],"ajaxDataType":"json","ajaxParams":{},"ajaxTimeout":3000,"ajaxType":"GET","maxItems":20,"matchHandler":m,"emphasisHandler":l,"createItemHandler":null,"async":false,"emphasis":true,"onerror":null},q);b.apply(this,[p]);i.apply(this)};var b=function(p){var q=this;this.inputView=f(p);this.inputView.attr("autocomplete","off").keyup(this._keyup=function(r){switch(r.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:e.apply(q);break;default:if(q.option.async){setTimeout(function(){g.apply(q)},0)}else{g.apply(q)}}}).keydown(this._keydown=function(s){switch(s.keyCode){case 38:o.apply(q,["up"]);break;case 40:o.apply(q,["down"]);break;case 13:var r=q.searchView.is(":visible");c.apply(q);if(r){return false}break}}).blur(this._blur=function(){f(document).one("click",function(){e.apply(q)})})};var i=function(){var p=this;this.searchView=f("<div class='ac'><ul></ul></div>").appendTo(document.body).on("mouseenter","li",function(){p.searchView.find("li.selected").removeClass("selected");f(this).addClass("selected")}).on("mouseleave","li",function(){f(this).removeClass("selected")}).on("click","li",function(){c.apply(p);e.apply(p)}).css("font-size",this.inputView.css("font-size"));f(window).resize(function(){j.apply(p)})};var h=function(p){var r=this,q=this.searchView.find("ul").empty();if(f.inArray(this.option.listStyle,["normal","iconList","custom"])==-1){n.apply(r,["遇到未知的listStyle参数！"]);return}f.each(p,function(t,v){var u=f("<li><div></div></li>").appendTo(q).addClass(r.option.listStyle).attr("val",v.value).find("div");switch(r.option.listStyle){case"normal":u.append("<span>"+v.label+"</span>");break;case"iconList":var s=f("<img></img>").attr("src",v.image);u.append(f("<div></div>").append(s)).append("<span>"+v.label+"</span>");break;case"custom":u.append(r.option.createItemHandler.apply(r,[t,v]));case"default":break}if(r.option.itemHeight>0){u.height(r.option.itemHeight).css("max-height",r.option.itemHeight)}})};var j=function(){if(this.option.listDirection==="down"){var q=this.inputView.offset().top+this.inputView.outerHeight()}else{if(this.option.listDirection==="up"){var q=this.inputView.offset().top-this.searchView.outerHeight()}else{n.apply(this,["遇到未知的listDirection参数！"]);return}}var p=this.inputView.offset().left;this.searchView.css("top",q+"px").css("left",p+"px")};var k=function(p){var q=this;if(this.option.listDirection==="up"){p=p.reverse()}h.apply(q,[p]);if(this.option.maxHeight>0){this.searchView.css("max-height",this.option.maxHeight+"px");if(f.browser.msie){this.searchView.css("height",this.searchView.height()>this.option.maxHeight?this.option.maxHeight+"px":"auto")}}j.apply(q);this.searchView.css("width",this.option.width+"px").show();o.apply(this,[this.option.listDirection])};var e=function(){this.searchView.find("ul").empty();this.searchView.hide()};var o=function(r){var s=this.searchView.find("li.selected");if(s.size()){var p=r==="up"?s.prev():s.next()}else{var p=r==="up"?this.searchView.find("li").last():this.searchView.find("li").first()}if(p.size()){this.searchView.find("li").removeClass("selected");p.addClass("selected");var t=p.outerHeight();var q=p.position().top;if(t+q>this.searchView.height()){this.searchView.scrollTop(this.searchView.scrollTop()+q+t-this.searchView.height())}else{if(q<0){this.searchView.scrollTop(this.searchView.scrollTop()+q)}}}};var c=function(){var p=this.searchView.find("li.selected");if(p.size()){this.inputView.val(p.attr("val"));e.apply(this)}};var a=function(p){jQuery.support.cors=true;var r=this,s=[],q={"async":false,"dataType":r.option.ajaxDataType,"type":r.option.ajaxType,"timeout":this.option.ajaxTimeout,"success":function(t,v,u){if(r.option.ajaxDataType==="xml"){f(t).find("item").each(function(){var y={"value":f(this).text(),"label":f(this).text()};for(var x=0;x<this.attributes.length;x++){var w=this.attributes[x].nodeName,z=this.attributes[x].nodeValue;y[w]=z}s.push(y)})}else{if(r.option.ajaxDataType==="json"){s=t}else{throw"遇到未知的ajaxDataType参数！"}}},"error":function(t,v,u){throw u}};if(f.isPlainObject(this.option.ajaxParams)){q["data"]=f.extend(false,{"keyword":p},this.option.ajaxParams)}else{if(f.isFunction(this.option.ajaxParams)){q["data"]=f.extend(false,{"keyword":p},this.option.ajaxParams.apply(this,[p]))}else{if(typeof(this.option.ajaxParams)==="string"){q["data"]="keyword="+p+"&"+this.option.ajaxParams}else{throw"遇到未知的ajaxParams参数！"}}}f.ajax(this.option.data,q);return s};var g=function(){var r=this,q=this.inputView.val(),s=[],p=[];if(f.trim(q).length==0){e.apply(r);return}if(f.isArray(this.option.data)){s=this.option.data}else{if(f.isFunction(this.option.data)){s=this.option.data.apply(this,[q])
}else{if(typeof(this.option.data)==="string"){try{s=a.apply(this,[q])}catch(t){n.apply(this,["Ajax错误:"+t]);return}}else{n.apply(this,["遇到未知的data参数！"]);return}}}f.each(s,function(u,w){if(r.option.maxItems>0&&p.length>=r.option.maxItems){return false}if(f.isPlainObject(w)){var v=f.extend(false,{},w)}else{if(typeof(w)==="string"){var v={"label":w,"value":w,"image":w}}else{n.apply(r,["数据源Item类型错误！"]);return false}}if(r.option.matchHandler.apply(r,[q,v])){p.push(v)}});if(q==this.inputView.val()){if(p.length>0){k.apply(this,[p])}else{e.apply(this)}}};var n=function(p){if(f.isFunction(this.option.onerror)){this.option.onerror.apply(this,[p])}};d.prototype.setOption=function(p){if(f.isPlainObject(p)){this.option=f.extend(false,this.option,p)}else{if(typeof(p)==="string"){switch(p){case"destroy":this.destroy();break;case"show":this.show();break;default:n.apply(this,["未知的AutoComplete参数！"]);return}}else{n.apply(this,["未知的AutoComplete参数类型！"]);return}}};d.prototype.destroy=function(){this.searchView.remove();this.inputView.unbind("keyup",this._keyup).unbind("keydown",this._keydown).unbind("blur",this._blur);delete this.inputView.get(0).controller};d.prototype.show=function(){if(this.option.async){setTimeout(function(){g.apply(this)},0)}else{g.apply(this)}};var m=function(p,r){var q=RegExp(p.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"i");if(this.option.emphasis&&f.isFunction(this.option.emphasisHandler)){this.option.emphasisHandler.apply(this,[p,r])}return q.test(r.value)};var l=function(p,r){var q=RegExp("("+p.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig");r.label=r.label.replace(q,"<em>$1</em>")}})(jQuery);